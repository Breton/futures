<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:fb="http://www.facebook.com/2008/fbml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Futures</title>
    <script src="vendor/jquery/jquery-1.4.2.js"></script>
    <script src="vendor/underscore/underscore-min.js"></script>
    <script src="http://bitbucket.org/JustinLove/es5/raw/c6103eab597c/es5.js"></script>
    <script src="http://vice-versa.googlecode.com/files/vice-versa.0.1.4b.min.js"></script>
    <script src="lib/futures.js"></script>
    <script>
      (function() {
        var AjaxUnit = {},
        tests = {},
        num_tests = 0,
        num_over = 0,
        begin;

        $(function () {
          $('<div id="ajax_unit_test"><span id="aut_num_tests"></span></div>').appendTo("body");
        });
        begin = function(name, wait) {
          var timeout;
          wait = wait || 10000; // undefind, 0, 'false' and false become 10seconds

          if (undefined !== tests[name]) {
            throw new Error('"'+name+'" is already defined');
          }
          tests[name] = undefined;
          num_tests += 1;
          $(function (){
            $("<div id='"+name+"'></div>").appendTo("#ajax_unit_test").html('"'+name+'" running...');
            $('#aut_num_tests').html(num_tests + ' tests running...');
          });

          // Timeout
          timeout = setTimeout(function() {
            if (undefined !== tests[name]) {
              throw new Error('"'+name+'" timed out after completing with status "'+tests[name]+'".');
            }
            num_over += 1;
            $(function (){$('#'+name).html('"'+name+'" failed');});
          }, wait);

          // Test(success||failure)
          return function (status) {
            //alert('booya!');
            if (undefined !== tests[name]) {
              alert('"'+name+'" completed after timeout with status "'+tests[name]+'".');
            }
            tests[name] = status;
            num_over += 1;
            clearTimeout(timeout);
            status = status && "Passed" || "Failed"
            $(function (){$('#'+name).html('"'+name+'" ' + status);});
          };
        }

        AjaxUnit.begin = begin;
        window.AjaxUnit = AjaxUnit;
      }());
    </script>
    <script>
      // Test App
      (function() {
        var data_store = {
          "contacts" :
            [
              {
                "name" : "AJ ONeal",
                "phone" : "317-4-COOLAJ",
                "email" : "coolaj86@email.com"
              },
              {
                "name" : "Jamshid Mavandi",
                "phone" : "801-MVND-AAI",
                "email" : "jamshid@mvndaai.name"
              }
            ]
        }

        function get_with_args(resource, callback, errback, delay) {
          if (undefined === delay) {
            delay = 281; // a goodly number of milliseconds
          }
          setTimeout(function() {
            if ("http://coolaj86.info/contacts" == resource) {
              callback && callback(datastore);
            } else if (callback) {
              errback && errback(datastore);
            }
          }, delay);
          return {
            // fake XHR
            abort : function(){}
          };
        }

        function get_with_hash(params) {
          get_with_args(params.resource, params.callback, params.errback, params.delay);
        }

        function get_with_promisable() {
          return function() {alert('override me');};
        }

        window.Asynkr = {
          get_with_args: get_with_args,
          get_with_hash: get_with_hash,
          get_with_promise: get_with_promisable()
        };
      }());

      // Demonstrate how to make, keep, and break a promise
      $(function(){
          var test = AjaxUnit.begin('Basic_Promise'),
          p = Futures.promise(),
          timeout = setTimeout(function() {
            p.smash("Suxorz!");
          }, 4000),
          passable_promise;

          $.getJSON("http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",
            { tags: "kitten", tagmode: "any", format: "json" },
            function(data){
              p.fulfill(data);
          });
          p.when(function(data) {
            clearTimeout(timeout);
          });
          p.fail(function(err) {
            alert("Timed out after 10 seconds with message '" + err + "'");
          });

          passable_promise = p.passable(); // Hide 'smash' and 'fulfill' methods
          passable_promise
            .when(function(data) { 
              data.items.slice(0,4).forEach(function(item,i,arr){
                $("<img class='basic'/>").attr("src", item.media.m).css("height", "150px").appendTo("body");
              });
            })
            .fail(function(data){ alert('Failure Message 2') })
          ;
          setTimeout(function(status) {
            status = false;
            if (4 === $("img.basic").length) {
              $("img.basic").remove();
              status = true;
            }
            test(status);
          }, 4000);
      });

      // Demonstrate that we can promisify a function
      $(function() {
        var test = AjaxUnit.begin('Basic_Promisify'),
        results = {},
        getJSON = Futures.promisify($.getJSON, { "when": 2, "fail": 3 });

        getJSON("http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",
          { tags: "cat", tagmode: "any", format: "json" }
          )
          // I can now issue multiple callbacks with .when()
          .when(function(data){
            data.items.slice(0,4).forEach(function(item,i,arr){
              $("<img class='promisify_args'/>").attr("src", item.media.m).css("height", "150px").appendTo("body");
            });
          })
          // passes in whichever result myFunc originally handed back
          .withResult(function(result){
            results.result = result;
          })
        ;

        // the old callback and errback are now optional and handled correctly if present
        getJSON("http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",
          { tags: "puppy", tagmode: "any", format: "json" },
          function(data){
            data.items.slice(0,4).forEach(function(item,i,arr){
              $("<img class='promisify_args'/>").attr("src", item.media.m).css("height", "150px").appendTo("body");
            });
          }
        );

        setTimeout(function(status) {
          status = false
          if (8 === $("img.promisify_args").length) {
            $("img.promisify_args").remove();
            status = true;
          }
          test(status);
        }, 4000);
      });

      // Custom Promisify
      $(function() {
        var test = AjaxUnit.begin('Custom_Promisify'),
        ajax,
        promisifiable = function (callback, errback) {
          return function() {
            // This is your interface. You can leave arguments as is,
            // or you can make it whatever you like
            var args = Array.prototype.slice.call(arguments),
            timeout,
            xhr;

            // jQuery.ajax has a timeout abstraction, but we'll create our own for example's sake.
            timeout = setTimeout(function() {
              // Crockford's promise doesn't cater to late-comers.
              // Once the timeout the call should be aborted for safety's sake.
              // If it were to succeed soon after it would throw.
              xhr.abort();
              errback("Timeout Failure");
            }, 4000);

            // Here we mangle the settings hash to our taste
            args[0]['error'] = errback;
            args[0]['success'] = function(data) {
              clearTimeout(timeout);
              callback(data);
            };
            xhr = $.ajax.apply($.ajax, args);
            return xhr;
          };
        };

        ajax = Futures.promisify(promisifiable, "custom"); // could still use params hash
        ajax({
          url: "http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",
          data: { tags: "dog", tagmode: "any", format: "json" }, 
          asnyc: true,
          dataType: "jsonp",
          //error: silently_ignored
          //success: silently_ignored
        })
          .when(function(data) {
            data.items.slice(0,4).forEach(function(item,i,arr) {
              $("<img class='promisify_custom'/>").attr("src", item.media.m).css("height", "150px").appendTo("body");
            });
          })
        ;

        setTimeout(function(status) {
          status = false;
          if (4 === $("img.promisify_custom").length) {
            $("img.promisify_custom").remove();
            status = true;
          } 
          test(status);
        }, 4000);
      });

      // Demonstrate that the joiner works
      (function() {
        var test = AjaxUnit.begin('Synchronous_Join'),
        p1 = Futures.promise(),
        p2 = Futures.promise(),
        p3 = Futures.promise(),
        j;

        j = Futures.join([p1, p2, p3]);
        j.when(function(arr) {
          setTimeout(function(status) {
            status = false;
            if ("Hello, World!" === arr.join('')) {
              status = true;
            }
            test(status);
          }, 4000);
        });

        p3.fulfill("World!");
        p1.fulfill("Hello");
        p2.fulfill(", ");
      }());


      // Demonstrate basic subscription
      $(function () {
        var test = AjaxUnit.begin('Basic_Subscription'),
        s = Futures.subscription(),
        i = 0;

        function recurse_subscription() {
          s.deliver(i += 1);
          if (i > 3) {
            return;
          }
          setTimeout(recurse_subscription, 1000);
        }
        setTimeout(recurse_subscription, 1000);

        s.subscribe(function (issue) {
          console.log('Delivery '+issue+' of 4 passes');
          if (4 === i) {
            test(true);
          }
        });
      }());
      
      // Demonstrate subscribify
      $(function () {
        var test = AjaxUnit.begin('Basic_Subscribify'),
        unsubscribe, 
        getJSON,
        keywords = ['trogdor', 'burninator', 'peasant', 'strongbad'],
        i = 0;


        //TODO optionally pass in a function which returns subscribe methods. This method with be synchronous in that
        //it gets called before the next line of the program executes. In this fashion it is possible to create a method
        //which is EXACTLY the same (inputs and outputs) as the original
        getJSON = Futures.subscribify($.getJSON, { "when": 2 }, "func which returns subscribe methods");
        function recurse_subscription() {
          if (i >= keywords.length) {
            return;
          }
          i += 1;
          getJSON("http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?",
              { tags: keywords[i], tagmode: "any", format: "json" });
          setTimeout(recurse_subscription, 1000);
        }
        setTimeout(recurse_subscription, 1000);
        unsubscribe = getJSON
          .subscribe(function(data) {
            data.items.slice(0,4).forEach(function(item) {
              $("<img class='subscribify'/>").attr("src", item.media.m).css("height", "150px").appendTo("body");
            });
            //alert("i: "+i);
            if (i == 4 && 16 == $(".subscribify").length) {
              //alert("yaboo!");
              test(true)
            }
          });

      }());
    </script>
  </head>
  <body>
    <div id="info"></div>
  </body>
</html>
